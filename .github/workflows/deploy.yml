name: éƒ¨ç½²åˆ°Netlify

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
  REACT_APP_SUPABASE_URL: ${{ secrets.REACT_APP_SUPABASE_URL }}
  REACT_APP_SUPABASE_ANON_KEY: ${{ secrets.REACT_APP_SUPABASE_ANON_KEY }}

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint-and-test:
    name: ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          client/package-lock.json
          server/package-lock.json
    
    - name: å®‰è£…å‰ç«¯ä¾èµ–
      run: |
        cd client
        npm ci
    
    - name: å®‰è£…åç«¯ä¾èµ–
      run: |
        cd server
        npm ci
    
    - name: å‰ç«¯ä»£ç æ£€æŸ¥
      run: |
        cd client
        npm run lint
    
    - name: å‰ç«¯ç±»å‹æ£€æŸ¥
      run: |
        cd client
        npm run type-check
      continue-on-error: true
    
    - name: å‰ç«¯æµ‹è¯•
      run: |
        cd client
        npm run test -- --coverage --watchAll=false
    
    - name: åç«¯æµ‹è¯•
      run: |
        cd server
        npm run test
      env:
        NODE_ENV: test
        DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
    
    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
      uses: codecov/codecov-action@v3
      with:
        directory: ./client/coverage
        flags: frontend
        name: frontend-coverage
    
    - name: ä¸Šä¼ åç«¯è¦†ç›–ç‡
      uses: codecov/codecov-action@v3
      with:
        directory: ./server/coverage
        flags: backend
        name: backend-coverage

  # æ„å»ºå‰ç«¯åº”ç”¨
  build:
    name: æ„å»ºå‰ç«¯åº”ç”¨
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: client/package-lock.json
    
    - name: å®‰è£…ä¾èµ–
      run: |
        cd client
        npm ci
    
    - name: æ„å»ºåº”ç”¨
      run: |
        cd client
        npm run build
      env:
        GENERATE_SOURCEMAP: false
        REACT_APP_ENV: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: build-files
        path: client/build/
        retention-days: 7

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è¿è¡ŒSnykå®‰å…¨æ‰«æ
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
        command: test
      continue-on-error: true
    
    - name: è¿è¡Œnpm audit
      run: |
        cd client
        npm audit --audit-level=moderate
        cd ../server
        npm audit --audit-level=moderate
      continue-on-error: true

  # éƒ¨ç½²åˆ°Netlify
  deploy:
    name: éƒ¨ç½²åˆ°Netlify
    runs-on: ubuntu-latest
    needs: [build, security-scan]
    if: github.event_name == 'push'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: build-files
        path: client/build/
    
    - name: éƒ¨ç½²åˆ°Netlify
      uses: nwtgck/actions-netlify@v2.0
      with:
        publish-dir: './client/build'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "éƒ¨ç½²æäº¤ ${{ github.sha }}"
        enable-pull-request-comment: true
        enable-commit-comment: true
        overwrites-pull-request-comment: true
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
    
    - name: è¿è¡ŒLighthouse CI
      uses: treosh/lighthouse-ci-action@v9
      with:
        configPath: './lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # éƒ¨ç½²åç«¯åˆ°Heroku
  deploy-backend:
    name: éƒ¨ç½²åç«¯åˆ°Heroku
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: éƒ¨ç½²åˆ°Heroku
      uses: akhileshns/heroku-deploy@v3.12.12
      with:
        heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
        heroku_app_name: "ai-workplace-api"
        heroku_email: ${{ secrets.HEROKU_EMAIL }}
        appdir: "server"
        procfile: "web: node index.js"
        
    - name: è¿è¡Œæ•°æ®åº“è¿ç§»
      run: |
        heroku run npm run migrate --app ai-workplace-api
      env:
        HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

  # é€šçŸ¥éƒ¨ç½²ç»“æœ
  notify:
    name: é€šçŸ¥éƒ¨ç½²ç»“æœ
    runs-on: ubuntu-latest
    needs: [deploy, deploy-backend]
    if: always()
    
    steps:
    - name: å‘é€æˆåŠŸé€šçŸ¥
      if: needs.deploy.result == 'success' && needs.deploy-backend.result == 'success'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: 'ğŸ‰ AIèŒåœºç²¾çµéƒ¨ç½²æˆåŠŸï¼'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
    
    - name: å‘é€å¤±è´¥é€šçŸ¥
      if: needs.deploy.result == 'failure' || needs.deploy-backend.result == 'failure'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: 'âŒ AIèŒåœºç²¾çµéƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # æ€§èƒ½ç›‘æ§
  performance-monitoring:
    name: æ€§èƒ½ç›‘æ§
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ç­‰å¾…éƒ¨ç½²å®Œæˆ
      run: sleep 60
      
    - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        npx lighthouse https://ai-workplace-genie.netlify.app \
          --chrome-flags="--headless --no-sandbox" \
          --output=json \
          --output-path=./lighthouse-report.json
      
    - name: åˆ†ææ€§èƒ½æŠ¥å‘Š
      run: |
        node -e "
          const report = require('./lighthouse-report.json');
          const scores = report.lhr.categories;
          console.log('æ€§èƒ½è¯„åˆ†:');
          console.log('Performance:', scores.performance.score * 100);
          console.log('Accessibility:', scores.accessibility.score * 100);
          console.log('Best Practices:', scores['best-practices'].score * 100);
          console.log('SEO:', scores.seo.score * 100);
          
          if (scores.performance.score < 0.8) {
            console.error('âš ï¸ æ€§èƒ½è¯„åˆ†ä½äº80åˆ†ï¼Œéœ€è¦ä¼˜åŒ–');
            process.exit(1);
          }
        "
      
    - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: lighthouse-report
        path: lighthouse-report.json

  # æ•°æ®åº“å¤‡ä»½ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
  backup-database:
    name: æ•°æ®åº“å¤‡ä»½
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: åˆ›å»ºæ•°æ®åº“å¤‡ä»½
      run: |
        pg_dump ${{ secrets.DATABASE_URL }} > backup-$(date +%Y%m%d-%H%M%S).sql
      env:
        PGPASSWORD: ${{ secrets.DB_PASSWORD }}
    
    - name: ä¸Šä¼ å¤‡ä»½åˆ°äº‘å­˜å‚¨
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: åŒæ­¥å¤‡ä»½æ–‡ä»¶
      run: |
        aws s3 cp backup-*.sql s3://ai-workplace-backups/database/
        
  # æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
  cleanup:
    name: æ¸…ç†èµ„æº
    runs-on: ubuntu-latest
    needs: [deploy, deploy-backend]
    if: always()
    
    steps:
    - name: æ¸…ç†æ—§çš„GitHub Artifacts
      uses: actions/github-script@v6
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId,
          });
          
          const oldArtifacts = artifacts.data.artifacts.filter(
            artifact => artifact.created_at < new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
          );
          
          for (const artifact of oldArtifacts) {
            await github.rest.actions.deleteArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: artifact.id,
            });
          }